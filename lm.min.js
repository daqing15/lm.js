function lm(a){if(!a)throw Error("Please provide a name for the db");db.store(a,{}),this.namespace=a,this.collections=[]}function Collection(a,b){this.name=a,this.namespace=b}function Query(a,b){this.namespace=a,this.collectionName=b}function Document(a,b){this.namespace=a,this.collectionName=b}function isEqual(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;var e=toString.call(a);if(e!=toString.call(b))return!1;switch(e){case"[object String]":return a==b+"";case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;c.push(a),d.push(b);var g=0,h=!0;if("[object Array]"==e){if(g=a.length,h=g==b.length)for(;g--&&(h=eq(a[g],b[g],c,d)););}else{for(var i in a)if(hasOwnProperty.call(a,i)&&(g++,!(h=hasOwnProperty.call(b,i)&&isEqual(a[i],b[i],c,d))))break;if(h){for(i in b)if(hasOwnProperty.call(b,i)&&!g--)break;h=!g}}return c.pop(),d.pop(),h}lm.prototype.create=function(a,b){if(!a)throw Error("Please specify a name");var c=db.retrieve(this.namespace);return c[a]=b||[],db.store(this.namespace,c),this.collections.push(a),new Collection(a,this.namespace)},lm.prototype.remove=function(a){if(!a)throw Error("Please specify a name");var b=this.collections.indexOf(a);if(0>b)throw Error("Collection does not exist");this.collections.splice(b,1);var c=db.retrieve(this.namespace);return delete c[a],db.store(this.namespace,c),this},lm.prototype.get=function(a){if(!a)throw Error("Please specify a name");var b=this.collections.indexOf(a);if(0>b)throw Error("Collection does not exist");return new Query(this.namespace,a)},Collection.prototype.add=function(a){if("object"!=typeof a)throw Error("Expecting an object but got "+typeof a);var b=db.retrieve(this.namespace);return b[this.name].push(a),db.store(this.namespace,b),this},Query.prototype.find=function(a,b){if(!arguments.length)throw Error("Please specify a criteria or a callback");"function"==typeof a&&(b=a,a={});var c=db.retrieve(this.namespace),d=c[this.collectionName];if(Object.keys(a).length){var e=Object.keys(a),f=new Document(this.namespace,this.collectionName),g=d.filter(function(b){for(var c=0,d=e.length-1;d>=0;d--)if(b[e[d]]===a[e[d]]&&(c++,b.__proto__=f,c===e.length))return!0});g.__proto__=this,b(g)}else b(d);return this},Document.prototype.update=function(a){var b=this,c=Object.keys(a),d=db.retrieve(this.namespace),e=d[this.collectionName],f=e.map(function(d){for(var e=c.length-1;e>=0;e--)d[c[e]]===b[c[e]]&&(d[c[e]]=a[c[e]],b[c[e]]=a[c[e]]);return d});return d[this.collectionName]=f,db.store(this.namespace,d),b},Document.prototype.remove=function(){var a=this,b=db.retrieve(this.namespace),c=b[this.collectionName],d=c.filter(function(b){return!isEqual(b,a,[],[])});b[this.collectionName]=d,db.store(this.namespace,b),a=void 0;for(var e=Object.keys(this),f=e.length-1;f>=0;f--)this[e[f]]=void 0;return a};var db={};db.store=function(a,b){localStorage.setObject(a,b)},db.retrieve=function(a){return localStorage.getObject(a)},db.remove=function(){localStorage.removeObject(key)},db.exists=function(a){var b=localStorage.getObject(a);return!!b&&!!Object.keys(b).length},db.clear=function(){localStorage.clear()},Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))},Storage.prototype.getObject=function(a){var b=this.getItem(a),c=b&&JSON.parse(b);return"string"==typeof c&&(c=c&&JSON.parse(c)),c},Storage.prototype.removeObject=function(a){this.removeItem(a)};
